# Troubleshooting - False Trigger Case (v0.3.1)

## 案例描述 (2026-02-26) - 續：Whisper 幻聽問題
在環境極度安靜時，除了 Edge Impulse 可能誤判外，Whisper ASR 有時會產生「重複性短語」的幻聽（Hallucination）。

### 觀測現象
- **現象**：ESP32 給出極高信心分數 (e.g., 0.895)，且 Whisper 辨識出「我认识了我认识了」等重複字句，導致系統誤啟動。
- **原因分析**：
  1. **Whisper 序列生成特性**：當音訊能量極低但有規律底噪時，模型會嘗試強行輸出文字，並陷入循環。
  2. **模型敏感度**：0.895 的信心分數代表環境底噪與喚醒詞特徵高度重疊。

## 修復與優化策略 (v0.3.2)
- **ASR 層 (ASR Level)**：
  - 加入 `no_speech_threshold=0.6`，讓 Whisper 自動過濾無聲片段。
  - 實作 **「重複性過濾 (Repetitive Filter)」**：若片段的 `no_speech_prob` 偏高且文字內容呈現重複模式（如前後半段相同），則予以攔截。
- **韌體層 (Firmware Level)**：
  - 將 `EI_CLASSIFIER_THRESHOLD` 進一步提升至 **`0.9`**。

## 調校建議 (Calibration Guide)
- **環境底噪分析**：如果 0.9 門檻仍無法擋住安靜時的誤觸，請務必將該音檔（Server 已自動存檔）下載並上傳至 Edge Impulse 作為 `Noise` 類別重新訓練。

## 案例描述 (2026-02-26) - 續：高分怪聲與 LLM 過度解讀
即使信心分數極高 (0.97 ~ 1.0)，發出的笑聲（哈哈哈哈）或怪聲（嗨唷唷）仍可能騙過分類器與 ASR。

### 觀測現象
- **現象**：Whisper 準確辨識出「哈哈哈哈」，但 LLM 會「強行賦予意義」，發明出不存在的動作如 `text_to_voice` 或產生格式錯誤的 JSON。
- **原因分析**：
  1. **特徵重疊**：笑聲或重複性發音在 MFCC 特徵上與喚醒詞高度相似。
  2. **小型 LLM 的侷限性**：0.5b 模型在處理「非指令文字」時容易產生幻覺。

## 修復與優化策略 (v0.3.3)
- **關鍵字攔截層 (Keyword Pre-filter)**：
  - 在 ASR 結束後、送往 LLM 前，先檢查文字是否包含任何 `DEVICE_ALIASES` 或 `ACTION_KEYWORDS`。
  - 若完全不包含控制要素，直接判定為誤觸。
- **Prompt 拒絕機制**：
  - 在 Prompt 中加入「非指令範例」，教育模型回傳 `{"action": "unknown"}`。
- **強化重複過濾**：
  - 增加連續相同字元（如 "哈哈哈哈"）的正規化過濾。

## 案例描述 (2026-02-26) - 續：記憶體吃緊與 VAD 遲鈍
在 ESP32 DevKit V1 (無 PSRAM) 上，靜態分配的錄音緩衝區佔用了過多記憶體，且過高的門檻導致使用者體驗不佳。

### 觀測現象
- **現象一**：DRAM 使用率高達 83%，剩餘 Heap 僅 30KB，系統存在穩定性風險。
- **現象二**：使用者反應需要大聲喊叫或對準麥克風才能觸發（VAD=2000, Conf=0.9）。

## 修復與優化策略 (v0.3.4)
- **動態記憶體管理**：
  - 改用 `malloc` 在喚醒成功後動態申請 96KB 錄音空間，並在傳送後 `free`。
  - 此舉將靜態 DRAM 佔用減少了 96KB，讓系統平時有更多資源處理通訊。
- **平衡性微調**：
  - 考量到已有 Server 端過濾層，將門檻適度放寬（VAD=1500, Conf=0.85），以找回靈敏度。

## 結論
透過調高 VAD 門檻與模型門檻的「雙重防護」，以及 Server 端的「空值過濾」，已大幅降低安靜環境下的誤觸機率。目前的動態記憶體優化更確保了無 PSRAM 硬體在長時間運作下的穩定性。

